---
title: "LtAtStructuR documentation"
author: "Noel Pimentel"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{LtAtStructuR documentation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
body .main-container {
max-width: 1280px !important;
width: 1280px !important;
}
body {
max-width: 1280px !important;
}

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo=FALSE}
library(data.table)

case_data0 <- data.frame(
  id      = 1:3,
  content = c("intnum=t", 
              "2021-04-21",
              "2021-05-20"),
  start   = c("2021-04-21", 
              "2021-04-21",
              "2021-05-20"),
  end     = c("2021-05-20",
              NA,
              NA),
  group   = c(1,3,4),
  type = c("background","box","box"),
  style = rep("background-color: #C0C0C0; font-size: 8pt",3)
)
```


<!-- Here we detail the structuring algorithm (with or without data coarsening) that is implemented by the `construct` routine of the `LtAtStructuR` package when it operates on an `LtAtData` object that was constructed based on an exposure object created with a call to the `setInstantExposure` function (as opposed to a call to the `setExposure` function). -->

## 1. Introduction

The R package `LtAtStructuR` automates the process of transforming longitudinal data (e.g. electronic health records data) into a structured analytic data set usable for marginal structural modeling (MSM). This data set, which is generated as output from the package, is suitable for the evaluation of the effects of exposure regimens (e.g. treatment plans) on a survival outcome based on MSM with inverse probability weighting or targeted minimum loss-based estimation. In order to create the output data set, an input cohort data set, an input exposure data set, and an optional input covariate data set(s) must be defined using `setCohort()`, `setExposure()`, and `setCovariate()`, respectively, and gathered into a single `LtAtData` object. This `LtAtData` object is then passed into `construct()` to create the final output data set.

The functionality below is designed to evaluate the effects defined by a single categorical variable at each time point.

## 2. Input data sets to be created by user

The creation of the following input data sets will often require substantial cleaning and manipulation of 'raw' data in studies based on electronic health records (EHR). For instance, when using drug dispensing data from the EHR, the preparation of an input data set that encodes a particular drug exposure will require the user to map fill dates and quantities dispensed into exposure periods that implement rules regarding, for example, the definition of gaps in medication possession and use of potential medication stockpile. Additionally, the input data sets must be of the class `data.table`

### 2.1 Cohort definition

The input cohort data set encodes: 

  1) baseline measurements
  2) dates of cohort entry and end of follow-up (eof), and 
  3) the reason for eof (i.e., occurrence of the outcome of interest or of a censoring event) for all subjects in the cohort
  
This data set should contain one row per subject and must include the following columns/variables (all other variables will be ignored):

-	Unique subject identifier ('ID') encoded as a numeric or character variable (e.g. medical record number). 
-	Index date (i.e., date of cohort entry) encoded as a date variable. 
-	End of follow-up date encoded as a date variable. 
-	Reason for end of follow-up encoded as a numeric or character variable. One value denotes occurrence of the outcome of interest (e.g., acute myocardial infarction) while all other values denote the various types of censoring events (e.g., death, health plan disenrollment, or administrative end of study)
-	Baseline measurement of time-dependent (e.g., HbA1c lab test results) covariate(s) or measurement of time-independent (e.g., sex, race) covariate(s) encoded as either a numeric or character variable. 

Missing values must be coded with `NA`. Note that data from rows with missing values in any of the first 4 colums above (ID,index/eof dates or reason of eof) will be ignored/discarded by the `LtAtStructuR` package. The `LtAtStructuR` package, however, will not ignore data from rows with missing values for any of the covariates measurements.

<!-- Example input cohort data set: -->

```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
library(LtAtStructuR)
`%+%` <- function(a, b) paste0(a, b)
input.cohort <- data.table::data.table(ID=c("000"%+%1:5),
                                       Index_date=lubridate::mdy(c("10/06/2008","05/18/2005","03/21/2006","06/17/2007","01/28/2008")),
                                       eof_dt=lubridate::mdy(c("09/30/2009","03/16/2007","11/30/2010","12/31/2010","12/31/2010")),
                                       EOF_reason=c("Lost_followup","Outcome","Lost_followup","Study_end","Study_end"),
                                       Race=c("BA","WH",NA,"AS","BA"),
                                       Hypertension=c(0,0,0,1,1),
                                       eGFR=as.numeric(c(NA,"48.2","61.0","59.7","71.3")),
                                       Stroke=c(1,1,0,1,0),
                                       Hosp_stay=c(0,1,1,0,1))
knitr::kable(input.cohort, caption = "Input cohort data")
```

Note that the output data set generated by the `LtAtStructuR` package will contain data from all subjects in the cohort data set, i.e., no systematic exclusion criteria are applied by the package Thus, if the inclusion of some subjects is not warranted to address the research question (e.g., subjects who previously experienced the exposure before the index date), then data from these subjects should be excluded from the cohort data set and all subsequent input data sets.

**Creating the cohort `LtAtData` object**

When creating the cohort `LtAtData` object, the user must specify the following arguments:

- `data` must be populated with the the name of the input cohort data set object
- `IDvar` must be populated with the name of the variable from the input cohort data set that contains the unique subject identifier
- `index_date` must be populated with the name of the variable from the input cohort data set that contains the index date
- `EOF_date` must be populated with the name of the variable from the input cohort data set that contains the end of follow-up dates
- `EOF_type` must be populated with the name from the input cohort data set that contains the reason for end of follow-up
- `Y_name` must be populated with the value of the reason for end of follow-up variable that denotes occurrence of the outcome of interest
- `L0` must be populated with the names of the variables from the input cohort data that contain the baseline covariate measurements
- `L0_timeIndep` must be populated with the names of the variables subset from `L0` that are time-independent with only the following three named elements:
  - `categorical`: specifies whether the covariate is continuous ('FALSE') or categorical ('TRUE'). Cannot be missing.
  - `impute`: specifies the imputation method for missing measurements: 'default', 'mean', 'mode', 'median'. If missing, imputation with the 'mean' and 'mode' is used for continuous and categorical covariates, respectively. Imputation with 'mean', 'mode', or 'median' is based on measurements from subjects with observed covariate values in data. 'mean' and 'median' can only be used for continuous covariates. 'mode' can only be used for categorical covariates. Imputation with 'default' replaces missing values with 0 if the covariate is numeric and with 'Unknown' otherwise.
  - `impute_default_level`: imputation value to be used when the imputation method is 'default'. The value must be a length 1 character (resp. numeric) for a covariate encoded by a character (resp. numeric) vector. If missing, the default values 0 and 'Unknown' are used for continuous and categorical covariates, respectively.

Define cohort object:
```{r}
cohort <- setCohort(data = input.cohort, 
                    IDvar = "ID", 
                    index_date = "Index_date", 
                    EOF_date = "eof_dt", 
                    EOF_type = "EOF_reason", 
                    Y_name = "Outcome", 
                    L0 = c("Race","Hypertension","eGFR","Stroke","Hosp_stay"), 
                    L0_timeIndep = list("Race"=list("categorical"=TRUE,
                                                    "impute"=NA,
                                                    "impute_default_level"=NA)) )
```

### 2.2 Exposure definition

Two types of exposure data can be handled by the package: interval and instantaneous exposures. Interval exposures corresponds to exposures that are experienced under intervals of time with a start and end date. The instantaneous exposures corresponds to exposures that occur on a single day.

#### 2.2.1 Interval exposures

The input exposure data set encodes the exposure regimens for all subjects in the cohort by describing intervals of time during which subjects are exposed to an exposure level other than the reference exposure level chosen by the user (i.e., the output data set created by the package will be based on the assumption that each patients is exposed to the reference level except if encoded otherwise by the exposure data set). Thus, if a subject only experiences the reference exposure level during follow-up, there should be no record for this subject in this exposure data set. Otherwise, this data set can contain multiple rows for the subject and must include the following four (and sometimes only the first three) variables (all others are ignored):

-	Unique subject identifier: the name of this column should be the same as the 'ID' column in the cohort data set. The values in this column must be a subset of the values in the 'ID' column in the cohort data set (because not all subjects will necessarily have experienced a non-reference exposure level).
-	Start date of a non-reference exposure episode encoded as a date variable. 
-	End date of a non-reference exposure episode encoded as a date variable. 
-	Value of the non-reference exposure level encoded as a numeric or character variable. This column is not required if the exposure variable is binary. The value for the non-reference exposure level used in the output data set created by the package will then be `1` by default.

The exposure episodes described by rows with the same ID must be non-overlapping.  Missing values are not allowed in the exposure data set. All subject identifiers in the exposure data set must also be present in the cohort data set.  In addition, while the exposure data set may contain measurements collected strictly before a subject's index date or strictly after a subject's end of follow-up date (both dates are specified in the cohort data set), all exposure measurements collected strictly before the index date or strictly after the eof date will be ignored/discarded by the package, i.e. the output data set created by the package will not incorporate these observations. The value that encodes the reference exposure level used in the output data set will be set to `0` if the fourth column of the input exposure data set described above is missing and, otherwise, it will be set to the specified value of the non-reference exosure level.

```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
input.exposure <- data.table::data.table(ID=c("0001","0001","0001","0003","0003"),
                                         Exposure_start=lubridate::mdy(c("07/21/2006","01/30/2009","08/14/2009","04/06/2006","03/30/2008")),
                                         Exposure_end=lubridate::mdy(c("11/30/2008","05/16/2009","10/13/2009","02/17/2008","06/18/2010")))

input.exposure.cat <- data.table::data.table(ID=c("0001","0001","0001","0003","0003"),
                                             Exposure_start=lubridate::mdy(c("07/21/2006","01/30/2009","08/14/2009","04/06/2006","03/30/2008")),
                                             Exposure_end=lubridate::mdy(c("11/30/2008","05/16/2009","10/13/2009","02/17/2008","06/18/2010")),
                                             Exposure_level=c("metformin","insulin","insulin","sulfonylurea","met+sul"))

knitr::kables(list(knitr::kable(input.exposure, caption = "Input exposure data for a binary exposure"),
                   knitr::kable(input.exposure.cat, caption = "Input exposure data for a categorical exposure")
                   ))
```


**Creating the exposure `LtAtData` object**

When creating the exposure `LtAtData` object, the user must specify the following arguments:

- `data` must be populated with the the name of the input exposure data set object
- `IDvar` must be populated with the name of the variable from the input exposure data set that contains the unique subject identifier
- `start_date`and `end_date` must be populated with the name of the variable from the input exposure data set that contains the exposure start and end dates, respectively
- If the exposure is categorical, `exp_level` must be populated with the name of the variable from the input exposure data set that contains the exposure categorical values; `exp_ref` must then be populated with the reference exposure level

Define exposure object:
```{r}
## Binary exposure
exposure <- setExposure(data = input.exposure,
                        IDvar = "ID",
                        start_date = "Exposure_start",
                        end_date = "Exposure_end")

## Categorical exposure
exposure.cat <- setExposure(data = input.exposure.cat,
                        IDvar = "ID",
                        start_date = "Exposure_start",
                        end_date = "Exposure_end",
                        exp_level = "Exposure_level",
                        exp_ref = "None")
```

#### 2.2.1 Instantaneous exposures

The input exposure data set encodes the exposure regimens for all subjects in the cohort by describing the single day during which the subjects are exposed to an exposure level other than the reference exposure level chosen by the user (i.e., the output data set created by the package will be based on the assumption that each patients is exposed to the reference level except if encoded otherwise by the exposure data set). Thus, if a subject only experiences the reference exposure level during follow-up, there should be no record for this subject in this exposure data set. Otherwise, this data set can contain multiple rows for the subject and must include the following three (and sometimes only the first two) variables (all others are ignored):

-	Unique subject identifier: the name of this column should be the same as the 'ID' column in the cohort data set. The values in this column must be a subset of the values in the 'ID' column in the cohort data set (because not all subjects will necessarily have experienced a non-reference exposure level).
-	Exposure date of a non-reference exposure episode encoded as a date variable. 
-	Value of the non-reference exposure level encoded as a numeric or character variable. This column is not required if the exposure variable is binary. The value for the non-reference exposure level used in the output data set created by the package will then be '1' by default.

The exposure episodes described by rows with the same ID must be non-overlapping.  Missing values are not allowed in the exposure data set. All subject identifiers in the exposure data set must also be present in the cohort data set.  In addition, while the exposure data set may contain measurements collected strictly before a subject's index date or strictly after a subject's end of follow-up date (both dates are specified in the cohort data set), all exposure measurements collected strictly before the index date or strictly after the eof date will be ignored/discarded by the package, i.e. the output data set created by the package will not incorporate these observations. The value that encodes the reference exposure level used in the output data set will be set to '0' if the third column of the input exposure data set described above is missing and, otherwise, it will be set to '0' if that column is specified as a numeric variable and it will be set to 'not exposed' if that column is a character variable.

```{r, echo=FALSE, results='asis', message=FALSE}
indexDate_001 <- input.cohort[ID=="0001",lubridate::as_date(Index_date)]
indexDate_003 <- input.cohort[ID=="0003",lubridate::as_date(Index_date)]

expDT <- setInstantExposure(
    rbind(data.table::data.table("ID"="0001","fill.date"=indexDate_001,"D.t"="analog insulin","Q.t"=15),
          data.table::data.table("ID"="0001","fill.date"=indexDate_001+10,"D.t"="analog insulin","Q.t"=90),
          data.table::data.table("ID"="0001","fill.date"=indexDate_001+10+80,"D.t"="analog insulin","Q.t"=90),
          data.table::data.table("ID"="0001","fill.date"=indexDate_001+10+90,"D.t"="human insulin","Q.t"=15),
          data.table::data.table("ID"="0001","fill.date"=indexDate_001+10+90+30,"D.t"="human insulin","Q.t"=180),
          data.table::data.table("ID"="0003","fill.date"=indexDate_003,"D.t"="analog insulin","Q.t"=15),
          data.table::data.table("ID"="0003","fill.date"=indexDate_003+1,"D.t"="analog insulin","Q.t"=90),
          data.table::data.table("ID"="0003","fill.date"=indexDate_003+2,"D.t"="human insulin","Q.t"=90)          
          ),
    "ID", "fill.date", c("D.t","Q.t"))

input_InstExp_bin <- expDT$data[,.(ID,fill.date)]
input_InstExp_cat <- expDT$data

knitr::kables(list(knitr::kable(input_InstExp_bin, caption = "Input exposure data for a binary exposure"),
                   knitr::kable(input_InstExp_cat, caption = "Input exposure data for a categorical exposure")
                   ))
```

**Creating the exposure `LtAtData` object**

When creating the exposure `LtAtData` object, the user must specify the following arguments:

- `data` must be populated with the the name of the input exposure data set object
- `IDvar` must be populated with the name of the variable from the input exposure data set that contains the unique subject identifier
- `exp_date` must be populated with the name of the variable from the input exposure data set that contains the exposure data
- If the exposure is categorical, `exp_level` must be populated with the name of the variable from the input exposure data set that contains the exposure categorical values; it can be missing if there is oly one non-reference exposure. If missing, the exposure is assumed to be binary and its reference level is encoded by 0

Define exposure object:
```{r}
## Binary exposure
exposure_instant_binary <- setInstantExposure(data = input_InstExp_bin,
                                              IDvar = "ID",
                                              exp_date = "fill.date")

## Categorical exposure
exposure_instant_categorical <- setInstantExposure(data = input_InstExp_cat,
                                                   IDvar = "ID",
                                                   exp_date = "fill.date",
                                                   exp_level = c("D.t","Q.t"))
```

### 2.3. Covariate definition

The input covariate data set(s) encode follow-up measurements strictly after baseline (i.e., index date) for all *time-dependent variables* (e.g., laboratory measurements, diagnosis, procedures, and drug prescriptions) other than the exposure, outcome and censoring variables. For each time-dependent covariate, a separate data set is used to store all follow-up measurements. This data set must include the following three (and sometimes only the first two) variables (all others are ignored):

-	Unique subject identifier: the name of this column should be the same as the 'ID' column in the cohort data set. The values in this column must be a subset of the values in the 'ID' column in the cohort data set (because not all subjects will necessarily have follow-up measurements).
-	Date of measurement encoded as a date variable. 
-	Value of measurement encoded as a numeric or character variable.  The name of this column and its variable type should match that of the column in the cohort data set that contains the baseline measurements for the same time-dependent covariate. This column is not required for covariates of behavior 1 (e.g., records of diagnoses or procedures).

Typically, each covariate data set will contain more than one row with the same 'ID', i.e. , multiple measurements per subject although some subjects may only have one follow-up measurement or none. However, each covariate data set must not contain more than one measurement per day for any given subject.  In addition, while each covariate data set may contain measurements collected before a subject's index date or after a subject's eof date (both dates are specified in the cohort data set), all covariate measurements collected on or before the index date or after the eof date will be ignored/discarded by the package, i.e. the output data set created by the package will not incorporate these observations. Missing covariate information during follow-up (i.e., after the index date or before or on the eof date) must be encoded by the absence of a record in the covariate data set. In other words, there should not be any missing values for the required three (sometimes two) columns outlined above in the covariate data sets. Finally, all subject identifiers in each covariate data set must also be present in the cohort data set.  

The argument `type` must be populated with the value `"binary monotone increasing"`, `"interval"`, `"sporadic"`, or `"indicator"` as described below:

#### 2.3.1 Binary monotone increasing

<!-- Example input covariate data set of type binary montone increasing: -->

```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
input.covariate.behav.1 <- data.table::data.table(ID=c("0001","0002","0003"),
                                                    Datevar=lubridate::mdy(c("04/01/2009","12/05/2006","05/01/2008")),
                                                    Hypertension=c(1,1,1))
knitr::kable(input.covariate.behav.1, caption = "Input covariate data set of type binary montone increasing")
```

-	The value of `"binary monotone increasing"` indicates that the covariate data set specified with `setCovariate()` is used by the package as a supplement to the cohort data set to create a single output time-dependent variable that is binary and monotone incresing with no missing values, i.e., its value remains either equal to its baseline value (0 or 1) during follow-up or its value changes once only during follow-up from its baseline valueof 0 to 1 and remains 1 thereafter. Examples of such covariates include binary indicators of a subject’s history of undergoing a given procedure or of receiving a given diagnosis. Note that values for the baseline measurements of a covariate of type `"binary monotone increasing"` must be provided in the cohort data set and missing values are not allowed. Only numeric baseline values 1 and 0 must be used for such covariates in the cohort data set. For any given subject with a baseline measurement of the covariate in the cohort data set equal to 0, the earliest date of the covariate measurement for that subject in the covariate data set will be interpreted by the package as the time when the output variable changes values from 0 to 1. All other measurements in the covariate data set for that subject, if any, will be ignored.  Because there should be no missing values in the output variable, the `impute` argument can be left blank. 

Example output data set of type binary monotone increasing:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.1.eg1 <- data.table::data.table(ID=rep("EG.ID1",3),intnum=0:2,censor=c(0,0,1),Hypertension=c(1,1,1))
knitr::kable(beh.1.eg1, caption = "On at baselin")
```

Example output data set of type binary monotone increasing:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.1.eg2 <- data.table::data.table(ID=rep("EG.ID2",3),intnum=0:2,censor=c(0,0,1),Hypertension=c(0,0,0))
knitr::kable(beh.1.eg2, caption = "Never on")
```

Example output data set of type binary monotone increasing:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.1.eg3 <- data.table::data.table(ID=rep("EG.ID3",3),intnum=0:2,censor=c(0,0,1),Hypertension=c(0,1,1))
knitr::kable(beh.1.eg3, caption = "On during follow-up")
```


#### 2.3.2 Interval

<!-- Example input covariate data set of type interval: -->

```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
input.covariate.behav.2 <- data.table::data.table(ID=c(sort(rep("000"%+%1:5,2))),
                                                  Datevar=lubridate::mdy(c("12/12/2008","12/17/2008","01/01/2006","01/03/2006","07/15/2008","07/30/2008","05/04/2009","05/10/2009","02/01/2008","02/06/2008")),
                                                  Hosp_stay=c(1,0,1,0,1,0,1,0,1,0))
knitr::kable(input.covariate.behav.2, caption = "Input covariate data set of type interval")
```

-	The value of `"interval"` indicates that the covariate data set specified with `setCovariate()` is used by the package as a supplement to the cohort data set to create a single output time-dependent variable that is categorical (possibly binary) or continuous with only observed/known values over time (i.e., missing values are not allowed). Examples of such covariates include variables that represent the temporal coverage of prescriptions or of hospitalization stays. Note that values for the baseline measurements of a covariate of type `"interval"` must be provided in the cohort data set and missing values are not allowed.  For any given subject, the date and value of all measurements for that subject in the covariate data set will be processed by the package to determine when, if at all, the output variable changes values and the corresponding updated values for that subject. Because there should be no missing values in the output variable, the `impute` argument can be left blank.

Example output data set of type interval:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.2.eg1 <- data.table::data.table(ID=rep("EG.ID1",3),intnum=0:2,censor=c(0,0,1),Hosp_stay=c(1,1,1))
knitr::kable(beh.2.eg1, caption = "Always on")
```

Example output data set of type interval:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.2.eg2 <- data.table::data.table(ID=rep("EG.ID2",3),intnum=0:2,censor=c(0,0,1),Hosp_stay=c(0,0,0))
knitr::kable(beh.2.eg2, caption = "Never on")
```

Example output data set of type interval:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.2.eg3 <- data.table::data.table(ID=rep("EG.ID3",3),intnum=0:2,censor=c(0,0,1),Hosp_stay=c(1,0,1))
knitr::kable(beh.2.eg3, caption = "On and off")
```

#### 2.3.3 Sporadic

<!-- Example input covariate data set of type sporadic: -->

```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
input.covariate.behav.4 <- data.table::data.table(ID=c("0001","0001","0002","0002","0003","0003","0004","0004","0005","0005"),
                                                  Datevar=lubridate::mdy(c("01/05/2009","05/08/2009","05/25/2005","07/12/2005","05/18/2007","04/08/2007","01/02/2008","05/09/2010","06/12/2008","03/14/2010")),
                                                  eGFR=c(42.8,43.6,64.7,55.4,60.1,52.3,70.2,64.3,45.7,53.8))
knitr::kable(input.covariate.behav.4, caption = "Input covariate data set of type sporadic:")
```

-	The value `"sporadic"` for indicates that the covariate data set specified with `setCovariate()` is used by the package as a supplement to the cohort data set to create an output time-dependent variable that is categorical (possibly binary) or continuous with observed and possibly unobserved values over time (i.e., missing values are allowed). Examples of such covariates include variables that represent laboratory measurements. Note that values for the baseline measurements of a covariate of type `"sporadic"` must be provided in the cohort data set and missing values are allowed and must be coded with `NA`. The `impute` argument must be populated with the value `default`, `mean`, `mode`, or `median` to indicate whether missing baseline values hould be impute with, respectively, the default value 0 ("Unknown" if the covariate is a character variable), the mean, the mode or median of the baseline values from subjects with non-missing baseline values. The defualt value 0/"Unknown" can be changed by populating the `impute_default_level` argument with another value. For any given subject, the date and value of all follow-up measurements in the covariate data set will be processed by the package to determine when, if at all, the output variable is measured during follow-up and the corresponding observed values for that subject.

Example output data set of type sporadic:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.4.eg1 <- data.table::data.table(ID=rep("EG.ID1",3),intnum=0:5,censor=c(0,0,0,0,0,1),eGFR=c(30.8,40.2,44.4,30.4,NA,39.1),I.eGFR=c(0,0,0,0,1,0))
knitr::kable(beh.4.eg1, caption = "Frequent monitoring")
```

Example output data set of type sporadic:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.4.eg2 <- data.table::data.table(ID=rep("EG.ID2",3),intnum=0:5,censor=c(0,0,0,0,0,1),eGFR=c(40.6,43.2,NA,NA,NA,40.4),I.eGFR=c(0,0,1,1,1,0))
knitr::kable(beh.4.eg2, caption = "Less frequent monitoring")
```

Example output data set of type sporadic:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.4.eg3 <- data.table::data.table(ID=rep("EG.ID3",3),intnum=0:5,censor=c(0,0,0,0,0,1),eGFR=c(56.7,NA,NA,NA,NA,NA),I.eGFR=c(0,1,1,1,1,1))
knitr::kable(beh.4.eg3, caption = "No monitoring after baseline")
```

#### 2.3.4 Indicator

<!-- Example input covariate data set of type indicator: -->

```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
input.covariate.behav.5 <- data.table::data.table(ID=c("0001","0002","0003","0003","0003","0004","0004","0004","0005"),
                                                  Datevar=lubridate::mdy(c("12/01/2008","02/15/2006","01/01/2007","02/02/2008","03/03/2009","11/10/2007","3/25/2009","10/31/2010","8/10/2010")),
                                                  Stroke=c(1,1,1,1,1,1,1,1,1))
knitr::kable(input.covariate.behav.5, caption = "Input covariate data set of type indicator")
```

-	The value `"indicator"` indicates that the covariate data set specified with `setCovariate()` is used by the package as a supplement to the cohort data set to create an output time-dependent variable that is categorical (possibly binary) or continuous with only observed/known values over time (i.e., missing values are not allowed). Examples of such covariates include variables that indicate occurrence of a given event (e.g., a stroke or a clinic visit). Non-occurrence of the event of interest is encoded by the default value “None” and 0 in the output data set created by the package for character and numeric values, respectively. Note that values for the baseline measurements of a covariate of type `"indicator"` must be provided in the cohort data set and missing values are not allowed. For any given subject, the date and value of all measurements for that subject in the covariate data set will be processed by the package to determine when, if at all, the output variable changes values and the corresponding updated values for that subject. Because there should be no missing values in the output variable, the `impute` argument can be left blank.

Example output data set of type indicator:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.5.eg1 <- data.table::data.table(ID=rep("EG.ID1",3),intnum=0:5,censor=c(0,0,0,0,0,1),Stroke=c(0,0,0,0,0,0))
knitr::kable(beh.5.eg1, caption = "No events during follow up")
```

Example output data set of type indicator:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.5.eg2 <- data.table::data.table(ID=rep("EG.ID2",3),intnum=0:5,censor=c(0,0,0,0,0,1),Stroke=c(1,0,0,0,0,0))
knitr::kable(beh.5.eg2, caption = "One event during follow up")
```

Example output data set of type indicator:
```{r, fig.show='hold', echo=FALSE, fig.height=15, fig.width=20, message=FALSE}
beh.5.eg3 <- data.table::data.table(ID=rep("EG.ID3",3),intnum=0:5,censor=c(0,0,0,0,0,1),Stroke=c(1,0,1,0,1,1))
knitr::kable(beh.5.eg3, caption = "Multiple events during follow up")
```

**Creating the covariate `LtAtData` objects**

When creating the covariate `LtAtData` object(s), the user must specify the following arguments:

- `data` must be populated with the the name of the time-dependent input covariate data set object
- `type` must be populated with `"binary monotone increasing"`, `"interval"`, `"sporadic"`, or `"indicator"`
- `IDvar` must be populated with the name of the variable from the input covariate data set that contains the unique subject identifier
- `L_date` must be populated with the date of the variable from the covariate data set that contains the dates of follow-up measurements
- `L_name` must be populated with the name of the variable from the covariate and/or cohort data set that contains the values of the covariate measurements
- `categorical` indicates if the covariate is continuous `categorical = FALSE` or categorical `categorical = TRUE`
- `impute` must be populated with `default`, `mean`, `mode`, or `median`; a value of `NA` will default to using the mean and mode for continuous and categorical covariates, respectively
- `impute_default_level` must be populated with a character or numeric string, if and only if `impute=default`, otherwise, it can be left empty; a value of `NA` will default to values of `0` and `'Unknown'` for continuous and categorical covariates, respectively
- `acute_change` must be set to `TRUE/FALSE`; a value of `TRUE` is used to indicate that a measurement of the covariate on a day when the exposure level changes may be the result of the exposure change, and a value of `FALSE` is used otherwise to indicate that the covariate measurement may be assumed to be unaffected by the change in exposure and thus assumed to have preceded (and possibly triggered) the change in exposure.

Define covariate objects:
```{r}
hypertension.cov <- setCovariate(data = input.covariate.behav.1,
                                 type = "binary monotone increasing",
                                 IDvar = "ID",
                                 L_date = "Datevar",
                                 L_name = "Hypertension",
                                 categorical = TRUE,
                                 impute = NA,
                                 impute_default_level = NA,
                                 acute_change = FALSE)

hosp_stay.cov <- setCovariate(data = input.covariate.behav.2,
                              type = "interval",
                              IDvar = "ID",
                              L_date = "Datevar",
                              L_name = "Hosp_stay",
                              categorical = TRUE,
                              impute = NA,
                              impute_default_level = NA,
                              acute_change = FALSE)

egfr.cov <- setCovariate(data = input.covariate.behav.4,
                         type = "sporadic",
                         IDvar = "ID",
                         L_date = "Datevar",
                         L_name = "eGFR",
                         categorical = FALSE,
                         impute = NA,
                         impute_default_level = NA,
                         acute_change = FALSE)

stroke.cov <- setCovariate(data = input.covariate.behav.5,
                           type = "indicator",
                           IDvar = "ID",
                           L_date = "Datevar",
                           L_name = "Stroke",
                           categorical = TRUE,
                           impute = NA,
                           impute_default_level = NA,
                           acute_change = FALSE)
```

## 3. Construct definition

The final step of the package `construct()` maps the input cohort, exposure, and covariate data sets into a structured analytic data set that encodes complex, discrete-time, longitudinal data; first, each input data set must be gathered into a single `LtAtData` object:

- Interval exposure

```{r}
## Final LtAtData object using binary exposure
LtAt.data.binary.At <- cohort + exposure + hypertension.cov + hosp_stay.cov + egfr.cov + stroke.cov

## Final LtAtData object using categorical exposure
LtAt.data.categorical.At <- cohort + exposure.cat + hypertension.cov + hosp_stay.cov + egfr.cov + stroke.cov
```

- Instantaneous exposure

```{r}
## Final LtAtData object using binary exposure
LtAt.data.binary.InstExp <- cohort + exposure_instant_binary + hypertension.cov + hosp_stay.cov + egfr.cov + stroke.cov

## Final LtAtData object using categorical exposure
LtAt.data.categorical.InstExp <- cohort + exposure_instant_categorical + hypertension.cov + hosp_stay.cov + egfr.cov + stroke.cov
```

A unit of time `time_unit` has to be specified before running the `construct` function, and must be populated with the number of days that will serve as the analytic unit of time in the output data set. This unit of time used to create discrete consecutive time intervals between the index date and end of follow-up.

The `format` argument must be populated with value `standard` or `MSM SAS macro`. A value of `MSM SAS macro` indicates that the output data set to be created by `LtAtStrucutR` should be formatted for direct use with the %MSM macro developed by the Harvard Causal Inference group. The %MSM macro automates MSM fitting with Inverse Probability Weighting estimation in studies with survival outcomes. The %MSM macro code and its documentation can be downloaded at https://www.hsph.harvard.edu/causal/software/ A value of `standard` indicates that the output data set created by `LtAtStructuR` will not be directly compatible for use with the %MSM macro but instead the output data set will be compatible for use with either the `ltmle` R package developed at the University of California, Berkeley or the `stremr` R package developed at the Kaiser Permanente Northern California, Division of Research.  The `ltmle` and `stremr` packages automate the fitting of MSM and dynamic MSM with both Inverse Probability Weighting estimation and Targeted Minimum Loss based Estimation in studies with survival outcomes. `ltmle` can be downloaded at http://cran.r-project.org/web/packages/ltmle. `stremr` can be downloaded at http://cran.r-project.org/web/packages/stremr.

The `first_exp_rule` argument must be populated with value 0 or 1. With this value, the user indicates to the package whether a subject should be deemed first exposed to a non-reference exposure level in the output data set when the subject experiences a non-reference exposure level for at least 1 day or for `exp_threshold` of the days of a time interval (we recall that each follow-up interval is defined by a number of days specified by `time_unit`). The value 1 in `first_exp_rule` is used to indicate that a subject is deemed first exposed to a non-reference exposure level during a time interval in the output data set if the exposure data set indicates exposure to a non-reference exposure level for at least one day of the interval. The value 0 is used to indicate that a subject is deemed first exposed to a non-reference exposure level during a time interval in the output data set if the exposure data set indicates exposure to a non-reference exposure level for at least `exp_threshold` of the days of the interval.  By default (i.e.., if the `exp_threshold` argument is left unpopulated), the value for `exp_threshold` used by the package is set to 50% but an alternate value can be specified by populating the `exp_threshold` argument with any other value lower than or equal to 1 but strictly greater than 0. The `max_exp_var` argument sets the limit for the maximum number of exposure variables that is expected when the exposure is defined using `setInstantExposure`. The `max_cov_var` argument sets the limit for the maximum number of variables that is expected to be created by the routine to encode the levels of each time-dependent covariate when the exposure is defined using `setInstantExposure`, The `summary_cov_var` argument indicates the coarsening method applied in each interval to summarize multiple measurements of a time-dependent covariate into a single summary measure when the exposure is defined using `setInstantExposure`. 

- Interval exposures

```{r}
LtAt.data.bin.At <- construct(LtAtspec = LtAt.data.binary.At,
                              time_unit = 30,
                              first_exp_rule = 1,
                              exp_threshold = 0.5,
                              format = "standard",
                              dates = FALSE)

LtAt.data.cat.At <- construct(LtAtspec = LtAt.data.categorical.At,
                              time_unit = 30,
                              first_exp_rule = 1,
                              exp_threshold = 0.5,
                              format = "standard",
                              dates = FALSE)
```

- Instantaneous exposures

```{r}
LtAt.data.bin.InstExp <- construct(LtAtspec = LtAt.data.binary.InstExp,
                                   time_unit = 30,
                                   first_exp_rule = 1,
                                   exp_threshold = 0.03,
                                   format = "standard",
                                   dates = FALSE)

LtAt.data.cat.InstExp <- construct(LtAtspec = LtAt.data.categorical.InstExp,
                                   time_unit = 30,
                                   first_exp_rule = 1,
                                   exp_threshold = 0.03,
                                   format = "standard",
                                   dates = FALSE)
```

```{r,echo=FALSE}
LtAt.data.bin.At.harvard <- construct(LtAtspec = LtAt.data.binary.At,
                                      time_unit = 30,
                                      first_exp_rule = 1,
                                      exp_threshold = 0.5,
                                      format = "MSM SAS macro",
                                      dates = FALSE)

LtAt.data.bin.At.harvard.dates <- construct(LtAtspec = LtAt.data.binary.At,
                                            time_unit = 30,
                                            first_exp_rule = 1,
                                            exp_threshold = 0.5,
                                            format = "MSM SAS macro",
                                            dates = TRUE)
```

## 4. Output data set

The output data set produced by the `LtAtStructuR` package organizes the processed longitudinal data for each patient in the cohort into a structured format suitable for analyses by MSM. As described in details in Section 5, each patient's follow-up time is first divided into intervals of constant length (i.e., `time_unit`). The various measurements in the input data sets are then mapped to these intervals. Each row of the resulting output data set encodes the measurements that characterize a given patient at one such interval. The output data set includes the following columns (the last two are only included when the exposure is categorical with more than two levels):

-	Unique subject identifier $ID$ encoded as a numeric or character variable (e.g. medical record number). 
-	Interval number $t$ encoded as a numeric variable, beginning at 0 and incrementing by 1 until the last interval.
-	Interval start and end dates $t_{min}$ and $t_{max}$, respectively, encoded as date variables. 
-	Reason for end-of-follow-up (EOF) $\Gamma$ encoded as a character variable.
-	Exposure status $A_1(t)$ encoded as a categorical (numeric or character) variable.
-	Outcome status $Y(t)$, encoded as a binary numeric variable.
-	Censoring status $A_2(t)$ encoded as a binary numeric variable.
-	Covariate statuses (one column per covariate: $L_1(t)$, $L_2(t)$, etc.) encoded as numeric or character variables.
-	Covariate imputation flags (one column per covariate: $I.L_1(t)$, $I.L_2(t)$, etc.) encoded as binary numeric variables. Each imputation variable indicates at each time interval whether or not the value of a given covariate was observed (value of '0') or either imputed or defined as the last observed value carried forward (value of '1').
-	Indicator of an exposure tie encoded as a binary numeric variable. A value of '1' for this variable indicates that a subject is exposed equally in duration to at least two distinct non-reference exposure levels (see section 5 for details)
-	Warning indicator of a possibly misleading exposure level assignment encoded as a binary numeric variable. A value of '1' for this variable indicates that a subject is deemed exposed to the reference level despite significant cumulative exposure to at least two non-reference exposure levels (see section 5 for details).

When `construct(...,format = "standard")` , the following two tables illustrate the encoding in the output data set of the longitudinal data from two patients who each, respectively, experienced and did not experience the event during follow-up (exposure is binary):

<!-- Patient who had the outcome: -->

```{r,echo=FALSE}
cols <- names(LtAt.data.bin.At)
LtAt.data.bin.At[, (cols) := lapply(.SD, factor), .SDcols = cols]
Yt1 <- LtAt.data.bin.At[ID=="0002",][c(1:3)]
Yt1[3,eval(names(Yt1)):="..."]
Yt1 <- rbind(Yt1,LtAt.data.bin.At[ID=="0002",][c(.N-1,.N)])
Yt1.kable <- knitr::kable(Yt1, "html", caption = "EOF reason is failure")
kableExtra::add_header_above(Yt1.kable, c("$ID$", "$t$", "$\\Gamma$", "$Y(t)$", "$A_2(t)$", "$L_1(t)$", "$I.L_1(t)$", "$L_2(t)$", "$I.L_2(t)$", "$L_3(t)$", "$L_4(t)$", "$L_5(t)$", "$A_1(t)$"))
```

<!-- Patient who was censored due to loss of follow-up: -->

```{r,echo=FALSE}
Yt0 <- LtAt.data.bin.At[ID=="0001",][c(1:3)]
Yt0[3,eval(names(Yt0)):="..."]
Yt0 <- rbind(Yt0,LtAt.data.bin.At[ID=="0001",][c(.N-1,.N)])
Yt0.kable <- knitr::kable(Yt0, "html", caption = "EOF reason is censoring")
kableExtra::add_header_above(Yt0.kable, c("$ID$", "$t$", "$\\Gamma$", "$Y(t)$", "$A_2(t)$", "$L_1(t)$", "$I.L_1(t)$", "$L_2(t)$", "$I.L_2(t)$", "$L_3(t)$", "$L_4(t)$", "$L_5(t)$", "$A_1(t)$"))
```

Note that each row of these tables contains the measurements of covariates $L_j(t)$ for $j=1,2,…$, exposure $A_1(t)$, outcome $Y(t)$ and censoring variable $A_2(t)$ for a given follow-up interval $t$. The columns $t_{min}$ and $t_{max}$ (i.e., `intstart` and `intend`, respectively) contain the dates of each follow-up interval defined by the unit of time specified by the user of the package (i.e., `time_unit`).  In particular, the value for `instart` in the first row of each table contains the index date for the patient. Because measurements of covariates may not be collected at each time point in non-experimental studies, the tables contain a separate column for each covariate $I.L_1(t$ and $I.L_2(t)$ that indicates whether the corresponding covariate is observed (i.e., the value '0' means that the covariate is observed). Tables such as the ones above are constructed for all patients in the cohort and stacked into a single data set that forms the output data set from the `LtAtStructuR` package.

The output data set just described cannot be used directly with the %MSM macro developed by the Harvard Causal Inference group to fit Marginal Structural Models by Inverse Probability Weighting estimation. For the output data set from the package `LtAtStructuR` to be directly usable by the %MSM macro, data from all patients who are censored during the first follow-up interval (i.e., at $t=0$) can be removed from the output data set, and, for all other patients, the values of the outcome ($Y(t)$) and censoring  ($A_2(t)$) columns of their tables can be shifted up by one row, the resulting last row can be deleted, and the outcome value in the new last row can be set to missing when $A_2(t)$ is 1 in the new last row. These steps are automated by the `LtAtStructuR` package when `construct(...,format = "MSM SAS macro")`. The resulting encoding in the output data set of the longitudinal data from the same two patients described above is illustrated in the following two tables: 

<!-- Patient who had the outcome: -->

```{r,echo=FALSE}
cols <- names(LtAt.data.bin.At.harvard)
LtAt.data.bin.At.harvard[, (cols) := lapply(.SD, factor), .SDcols = cols]
Yt1 <- LtAt.data.bin.At.harvard[ID=="0002",][c(1:3)]
Yt1[3,eval(names(Yt1)):="..."]
Yt1 <- rbind(Yt1,LtAt.data.bin.At.harvard[ID=="0002",][c(.N-1,.N)])
Yt1.kable <- knitr::kable(Yt1, "html", caption = "EOF reason is failure")
kableExtra::add_header_above(Yt1.kable, c("$ID$", "$t$", "$\\Gamma$", "$Y(t)$", "$A_2(t)$", "$L_1(t)$", "$I.L_1(t)$", "$L_2(t)$", "$I.L_2(t)$", "$L_3(t)$", "$L_4(t)$", "$L_5(t)$", "$A_1(t)$"))
```

<!-- Patient who was censored due to loss of follow-up: -->

```{r,echo=FALSE}
Yt0 <- LtAt.data.bin.At.harvard[ID=="0001",][c(1:3)]
Yt0[3,eval(names(Yt0)):="..."]
Yt0 <- rbind(Yt0,LtAt.data.bin.At.harvard[ID=="0001",][c(.N-1,.N)])
Yt0.kable <- knitr::kable(Yt0, "html", caption = "EOF reason is censoring")
kableExtra::add_header_above(Yt0.kable, c("$ID$", "$t$", "$\\Gamma$", "$Y(t)$", "$A_2(t)$", "$L_1(t)$", "$I.L_1(t)$", "$L_2(t)$", "$I.L_2(t)$", "$L_3(t)$", "$L_4(t)$", "$L_5(t)$", "$A_1(t)$"))
```

In addition, when `construct(...,dates = TRUE)` the measurement dates for the covariates will be displayed:

```{r,echo=FALSE}
cols <- names(LtAt.data.bin.At.harvard.dates)
LtAt.data.bin.At.harvard.dates[, (cols) := lapply(.SD, factor), .SDcols = cols]
Yt1 <- LtAt.data.bin.At.harvard.dates[ID=="0002",][c(1:3)]
Yt1[3,eval(names(Yt1)):="..."]
Yt1 <- rbind(Yt1,LtAt.data.bin.At.harvard.dates[ID=="0002",][c(.N-1,.N)])
Yt1.kable <- knitr::kable(Yt1[,.(ID,intnum,intstart,intend,eGFR,dteGFR,Hosp_stay,dtHosp_stay,Hypertension,dtHypertension,Stroke,dtStroke)], "html", caption = "Output with dates")
# Yt1.kable <- knitr::kable(LtAt.data.bin.At.harvard.dates[,.(ID,intnum,intstart,intend,eGFR,dteGFR,Hosp_stay,dtHosp_stay,Hypertension,dtHypertension,Stroke,dtStroke)],"html")
kableExtra::add_header_above(Yt1.kable, c("$ID$", "$t$", "$t_{min}$", "$t_{max}$", "$L_2(t)$", "$date.L_2(t)$", "$L_3(t)$", "$date.L_3(t)$", "$L_4(t)$", "$date.L_4(t)$", "$L_5(t)$","$date.L_5(t)$"))
```


<!-- ## 5. Under the hood -->

<!-- The coarsening of the user-specified input data (referred to as 'raw data' below) into the output data set described above starts with the discretization of each patient’s follow-up time into consecutive intervals that are each `time_unit` days long. Starting at $t=0$, each interval is stamped with a counter denoted by $t$. The first day of the interval stamped with $t=0$ is the subject’s index date. For each subject, the last follow-up interval contains the day when the subject was either censored or follows the interval that contains the day when the subject experienced the outcome of interest. -->

<!-- The next step in the coarsening of the input data consists in simultaneously assigning values for the exposure, outcome, and censoring status for each time interval $t$ in the output data set according to one of the following two logics.  -->

<!-- ### 5.1 Mapping of exposure, outcome and censoring information in input data sets to the output data set -->

<!-- One of the two logics described below is implemented iteratively for $t=0, 1,…$ and for one subject at a time (in parallel if specified) to assign values to the  exposure, outcome and censoring variables in the output data set.  The notation $A(t)$ (also shorten with $A$) below refers to the exposure status at interval $t$ . The notation $C(t)$ (also shorten with $C$) below refers to the censoring status at interval $t$. The notation $Y(t)$ (also shorten with $Y$) below refers to the outcome status at interval $t$.  The diagrams are used as illustration of the scenarios when each assignment rule applies. Note that for each subject and each interval $t$, the exposure, outcome and censoring values are assigned simultaneously. For simplicity, we use the terminology “exposure level” in the tables below to designate a “non-reference exposure level”. -->

<!-- #### 5.1.1 Logic 1 (`first_exp_rule = 1`) -->

<!-- This first logic is implemented when the user sets the `first_exp_rule` argument of the `construct` function to 1 (see Section 3). The rules below are then implemented iteratively for each interval $t$ of the same subject until (and including) the first time $t$ (if any) when $A(t)$ is assigned the value $j$:  -->

<!-- ##### 5.1.1.1 Case 1a  -->

<!-- The subject experiences at least one of the exposure levels for at least one day of interval $t$, and $t$ is not the last interval. We denote the most frequent exposure level in interval $t$ by $j$. If the exposure is binary, then $j=1$ by definition. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as the level involved in the tie that the patient experienced last during the interval t. -->

<!-- - Highest Frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=1","2021-05-05","2021-05-08","A=2","2021-04-22","2021-05-04"), -->
<!--                                          start=c("2021-05-05","2021-05-05","2021-05-08","2021-04-22","2021-04-22","2021-05-04"), -->
<!--                                          end=c("2021-05-08",NA,NA,"2021-05-04",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px", width="1215px") -->
<!-- ``` -->


<!-- - Tie: -->


<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->

<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=1","2021-05-05","2021-05-17","A=2","2021-04-22","2021-05-04"), -->
<!--                                          start=c("2021-05-05","2021-05-05","2021-05-17","2021-04-22","2021-04-22","2021-05-04"), -->
<!--                                          end=c("2021-05-17",NA,NA,"2021-05-04",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0")) -->

<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.2 Case 2a  -->

<!-- The subject does not experience any of the exposure levels during interval $t$, and $t$ is not the last interval. -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data0, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "317px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.3 Case 3a  -->

<!-- The subject experiences the failure event during interval $t$ and none of the exposure levels before the failure event. -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:4, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "Y=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-09"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4, -->
<!--                                          content=c("Y=1"), -->
<!--                                          start=c("2021-05-09"), -->
<!--                                          end=c(NA), -->
<!--                                          type=c("box"), -->
<!--                                          style=c("background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "397px", width="1215px") -->
<!-- ``` -->

<!-- ##### 5.1.1.4 Case 4a  -->

<!-- The subject experiences a right-censoring event during interval $t$ and none of the exposure levels before the censoring event. -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:4, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-09"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4, -->
<!--                                          content=c("C=1"), -->
<!--                                          start=c("2021-05-09"), -->
<!--                                          end=c(NA), -->
<!--                                          type=c("box"), -->
<!--                                          style=c("background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "317px",width="1215px") -->
<!-- ``` -->

<!-- ##### 5.1.1.5 Case 5a -->

<!-- The subject experiences a right-censoring event during interval $t$ and at least one of the exposure levels before the censoring event. We denote the most frequent exposure level in interval $t$ prior to and including the day of the censoring event by $j$. If the exposure is binary, then $j=1$ by definition. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as the level involved in the tie that the patient experienced **last** during interval $t$ **up to and including the day when the censoring event occurs.** -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-22", -->
<!-- #               "2021-05-09"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-08", -->
<!-- #               "2021-05-04", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("C=1","A=2","2021-04-22","2021-05-04","A=1","2021-05-05","2021-05-08"), -->
<!--                                          start=c("2021-05-09","2021-04-22","2021-04-22","2021-05-04","2021-05-05","2021-05-05","2021-05-08"), -->
<!--                                          end=c(NA,"2021-05-04",NA,NA,"2021-05-08",NA,NA), -->
<!--                                          type=c("box","background","box","box","background","box","box"), -->
<!--                                          style=c("background-color: #E69138; font-size: 8pt", -->
<!--                                          rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                          rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(3,2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-15", -->
<!-- #               "2021-05-01", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("C=1","A=2","2021-04-22","2021-05-04","A=1","2021-05-05","2021-05-17"), -->
<!--                                          start=c("2021-05-19","2021-04-22","2021-04-22","2021-05-04","2021-05-05","2021-05-05","2021-05-17"), -->
<!--                                          end=c(NA,"2021-05-04",NA,NA,"2021-05-17",NA,NA), -->
<!--                                          type=c("box","background","box","box","background","box","box"), -->
<!--                                          style=c("background-color: #E69138; font-size: 8pt", -->
<!--                                          rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                          rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(3,2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=1<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.6 Case 6a -->

<!-- The subject experiences the failure event during interval $t$ and at least one of the exposure levels before the failure event. We denote the most frequent exposure level in interval $t$ prior to and including the day of the failure event by $j$. If the exposure is binary, then $j=1$ by definition. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as the level involved in the tie that the patient experienced **last** during interval $t$ **up to and including the day when the failure event occurs.** -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-22", -->
<!-- #               "2021-05-09"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-08", -->
<!-- #               "2021-05-04", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("Y=1","A=2","2021-04-22","2021-05-04","A=1","2021-05-05","2021-05-08"), -->
<!--                                          start=c("2021-05-09","2021-04-22","2021-04-22","2021-05-04","2021-05-05","2021-05-05","2021-05-08"), -->
<!--                                          end=c(NA,"2021-05-04",NA,NA,"2021-05-08",NA,NA), -->
<!--                                          type=c("box","background","box","box","background","box","box"), -->
<!--                                          style=c("background-color: #E06666; font-size: 8pt", -->
<!--                                          rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                          rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(3,2,3,4,2,3,4))) -->


<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "434px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-06", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("Y=1","A=2","2021-04-22","2021-05-04","A=1","2021-05-05","2021-05-17"), -->
<!--                                          start=c("2021-05-19","2021-04-22","2021-04-22","2021-05-04","2021-05-05","2021-05-05","2021-05-17"), -->
<!--                                          end=c(NA,"2021-05-04",NA,NA,"2021-05-17",NA,NA), -->
<!--                                          type=c("box","background","box","box","background","box","box"), -->
<!--                                          style=c("background-color: #E06666; font-size: 8pt", -->
<!--                                          rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                          rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(3,2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "434px",width="1215px")  -->
<!-- ``` -->

<!-- For all subsequent intervals $t$ (if any) of the same subject, the following rules are applied iteratively instead. If the variable $X$ referenced below is not specified explicitly by the user in the function `construct()` (section 3 – see `exp_threshold`), it is then is set to 0.50 by default in the current implementation of the `LtAtStructuR` package. We note that case 7a is skipped intentionally below.  In all the examples below $X = 0.50$. -->

<!-- ##### 5.1.1.7 Case 8a -->

<!-- If the exposure is binary, $t$ is not the last interval and the average exposure during interval $t \ge X$ then this case applies, and we then define $j=1$. Or, the exposure is not binary and the subject experiences at least one of the exposure levels for at least one day of interval $t$, and $t$ is not the last interval. We then denote the most frequent exposure level in interval $t$ by $j$. If the proportion of days exposed during interval $t$ to level $j \ge X$ then this case applies. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as $A(t-1)$, if $A(t-1)$ was set to one of the levels involved in the tie at time $t$; and, otherwise, $k$ is set to the level involved in the tie that the patient experienced last during the interval $t$. -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-08"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=1","2021-05-10","2021-05-19", -->
<!--                                                    "A=2","2021-04-22","2021-05-07"), -->
<!--                                          start=c("2021-05-10","2021-05-10","2021-05-19", -->
<!--                                                  "2021-04-22","2021-04-22","2021-05-07"), -->
<!--                                          end=c("2021-05-19",NA,NA, -->
<!--                                                "2021-05-07",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "391px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05","A=1","2021-05-06","2021-05-20"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05","2021-05-06","2021-05-06","2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA,"2021-05-20",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=2<br><b>Variable Assignment:</b><br>A(t)=k=2<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05","A=1","2021-05-06","2021-05-20"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05","2021-05-06","2021-05-06","2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA,"2021-05-20",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=3<br><b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.8 Case 9a -->

<!-- The exposure is binary, $t$ is not the last interval and average exposure during interval  $t<X$. Or, the exposure is not binary and interval $t$ is not the last interval. We then denote the most frequent exposure level in interval $t$ by $j$. If the proportion of days exposed during interval $t$ to level $j<X$ then this case applies. If the sum of the proportions of days exposed to any possible level is $>X$ then a warning indicator is set to 1. We note that even if the exposure is not binary and two exposure levels have equal frequencies, the tie indicator remains at 0 for case 9a (because $A(t)$ is then set to 0)  -->

<!-- - $j < X$ and sum or proportions of days exposed $<X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-04-25"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-04-25","A=1","2021-05-06","2021-05-09"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-04-25","2021-05-06","2021-05-06","2021-05-09"), -->
<!--                                          end=c("2021-04-25",NA,NA,"2021-05-09",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - $j < X$ and sum or proportions of days exposed $\geq X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-03"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-04","A=1","2021-05-06","2021-05-09"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-04","2021-05-06","2021-05-06","2021-05-09"), -->
<!--                                          end=c("2021-05-04",NA,NA,"2021-05-09",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.9 Case 10a -->

<!-- The exposure is binary, $t$ is the last interval and a right-censoring event occurs during the interval. We then compute the average exposure during the days of the interval **up to and including the day** when $C$ occurs. If this average is $\ge X$ then this case applies and we define $j=1$. Or, the exposure is not binary, $t$ is the last interval, the subject experiences a right-censoring event during interval $t$, and at least one of the exposure levels before the censoring event.  We then denote the most frequent exposure level in interval $t$ **up to and including the day when the censoring event occurs** by $j$. If the proportion of days exposed during interval $t$ to level $h \ge X$ then this case applies. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as $A(t-1)$, if $A(t-1)$ was set to one of the levels involved in the tie at time $t$; and, otherwise, $k$ is set to the level involved in the tie that the patient experienced last during the interval $t$ and **up to and including the day when the censoring event occurs.** -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-14"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-08", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=1","2021-05-08","2021-05-17", -->
<!--                                                    "A=2","2021-04-22","2021-05-07", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-05-08","2021-05-08","2021-05-17", -->
<!--                                                  "2021-04-22","2021-04-22","2021-05-07", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-17",NA,NA, -->
<!--                                                "2021-05-07",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05", -->
<!--                                                    "A=1","2021-05-06","2021-05-20", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-20", -->
<!--                                                  "2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA, -->
<!--                                                "2021-05-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=2<br><b>Variable Assignment:</b><br>A(t)=k=2<br>Y(t)=0<br>C(t)=1<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05", -->
<!--                                                    "A=1","2021-05-06","2021-05-20", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-20", -->
<!--                                                  "2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA, -->
<!--                                                "2021-05-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=3<br><b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=1<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.10 Case 11a -->

<!-- The exposure is binary, $t$ is the last interval and a right-censoring event occurs during interval $t$. We then compute the average exposure during the days of the interval **up to and including the day** when $C$ occurs. If this average is $<X$, then this case applies. Or, the exposure is not binary, $t$ is the last interval, the subject experiences a right-censoring event during interval $t$.  We then denote the most frequent exposure level in interval $t$ **up to and including the day when the censoring event occurs** by $j$. If the proportion of days exposed during interval $t$ to level $j<X$ then this case applies. If the sum of the proportions of days exposed to any possible level is $>X$ then a warning indicator is set to 1. We note that even if the exposure is not binary and two exposure levels have equal frequencies, the tie indicator remains at 0 for case 11a (because $A(t)$ is then set to 0. -->

<!-- - $j < X$ and sum or proportions of days exposed $<X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-14"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-04-25", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-04-25", -->
<!--                                                    "A=1","2021-05-06","2021-05-09", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-04-25", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-09", -->
<!--                                                  "2021-05-09"), -->
<!--                                          end=c("2021-04-25",NA,NA, -->
<!--                                                "2021-05-09",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - $j < X$ and sum or proportions of days exposed $\geq X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-14"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-03", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-04", -->
<!--                                                    "A=1","2021-05-06","2021-05-09", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-04", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-09", -->
<!--                                                  "2021-05-09"), -->
<!--                                          end=c("2021-05-04",NA,NA, -->
<!--                                                "2021-05-09",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.1.11 Case 12a -->

<!-- The exposure is binary, $t$ is the last interval and the subject experiences the failure event during interval $t$. We then define $Z$ as the number of days in each interval (i.e., $Z=\text{unitdays}$) and we compute the average exposure during the $Z$ days **up to and including the day** when the failure event $Y$ occurs. If this average is $\ge X$, then this case applies and we define $j=1$. Or, the exposure is not binary and the subject experiences the failure event during interval $t$, and at least one of the exposure levels before the failure event.  We denote the most frequent exposure level during the $Z$ days **up to and including the day** when the failure event occurs by $j$. If the proportion of days exposed during interval $t$ to level $j \ge X$ then this case applies. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as$ A(t-1)$, if $A(t-1)$ was set to one of the levels involved in the tie at time $t$; and, otherwise, $k$ is set to the level involved in the tie that the patient experienced last during **the interval defined by the $Z$ days up to and including the day when the failure event occurs.** -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:11, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "A=1", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-20", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-11", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-19", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-04-19", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,4,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-20","2021-05-05", -->
<!--                                                    "A=1","2021-05-06","2021-05-20", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-20","2021-04-20","2021-05-05", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-20", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-05-05",NA,NA, -->
<!--                                                "2021-05-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "588px", width="1215px") -->
<!-- ``` -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-01", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-20", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-19", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-19","2021-05-03", -->
<!--                                                    "A=1","2021-05-04","2021-05-18", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-03", -->
<!--                                                  "2021-05-04","2021-05-04","2021-05-18", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-05-03",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=2<br><b>Variable Assignment:</b><br>A(t)=k=2<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "628px",width="1215px") -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-01", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-20", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-19", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-19","2021-05-03", -->
<!--                                                    "A=1","2021-05-04","2021-05-18", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-03", -->
<!--                                                  "2021-05-04","2021-05-04","2021-05-18", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-05-03",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=3<br><b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "628px",width="1215px") -->
<!-- ``` -->

<!-- ##### 5.1.1.12 Case 13a -->

<!-- The exposure is binary, $t$ is the last interval and the subject experiences the failure event during interval $t$. We then define $Z$ as the number of days in each interval (i.e., $Z=\text{unitdays}$) and we compute the average exposure during the $Z$ days **up to and including the day** when the failure event $Y$ occurs. If this average is $<X$, then this case applies. Or, the exposure is not binary, $t$ is the last interval, the subject experiences the failure event during interval $t$.  We denote the most frequent exposure level during the $Z$ days **up to and including the day** when the failure event occurs by $j$. If the proportion of days exposed during interval $t$ to level $j<X$ then this case applies. If the sum of the proportions of days exposed to any possible level is $>X$ then a warning indicator is set to 1. We note that even if the exposure is not binary and two exposure levels have equal frequencies, the tie indicator remains at 0 for cases 13a (because $A(t)$ is then set to 0).  -->

<!-- - $j < X$ and sum or proportions of days exposed $<X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-20", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-06", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-19", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-20","2021-04-28", -->
<!--                                                    "A=1","2021-05-06","2021-05-09", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-20","2021-04-20","2021-04-28", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-09", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-04-28",NA,NA, -->
<!--                                                "2021-05-09",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "550px",width="1215px") -->
<!-- ``` -->

<!-- - $j < X$ and sum or proportions of days exposed $\ge X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-20", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-19", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-20","2021-04-28", -->
<!--                                                    "A=1","2021-05-06","2021-05-12", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-20","2021-04-20","2021-04-28", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-12", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-04-28",NA,NA, -->
<!--                                                "2021-05-12",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=1<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "550px",width="1215px") -->
<!-- ``` -->

<!-- #### 5.1.2 Logic 2 (`first_exp_rule = 0`) -->

<!-- This second logic is implemented when the user sets the `first_exp_rule` argument of the `construct` function to 0 (see Section 3). The rules below are then implemented iteratively for each interval $t$ of the same subject: -->

<!-- ##### 5.1.2.1 Case 1b -->

<!-- The exposure is binary, $t$ is not the last interval and the average exposure during interval $t \ge X$. We then define $j=1$. Or, the exposure is not binary and the subject experiences at least one of the exposure levels for at least one day of interval $t$, and $t$ is not the last interval. We then denote the most frequent exposure level in interval $t$ by $j$. If the proportion of days exposed during interval $t$ to level $j \ge X$ then this case applies. -->
<!-- If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as $A(t-1)$, if $A(t-1)$ was set to one of the levels involved in the tie at time $t$; and, otherwise, (including if $t=0$) $k$ is set to the level involved in the tie that the patient experienced last during the interval $t$. -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-08"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=1","2021-05-10","2021-05-19", -->
<!--                                                    "A=2","2021-04-22","2021-05-07"), -->
<!--                                          start=c("2021-05-10","2021-05-10","2021-05-19", -->
<!--                                                  "2021-04-22","2021-04-22","2021-05-07"), -->
<!--                                          end=c("2021-05-19",NA,NA, -->
<!--                                                "2021-05-07",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "391px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->

<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05","A=1","2021-05-06","2021-05-20"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05","2021-05-06","2021-05-06","2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA,"2021-05-20",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=2<br><b>Variable Assignment:</b><br>A(t)=k=2<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05","A=1","2021-05-06","2021-05-20"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05","2021-05-06","2021-05-06","2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA,"2021-05-20",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=3<br><b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.2.2 Case 2b -->

<!-- The exposure is binary, $t$ is not the last interval and the average exposure during interval  $t<X$. Or, the exposure is not binary and interval $t$ is not the last interval. We then denote the most frequent exposure level in interval $t$ by $j$. If the proportion of days exposed during interval $t$ to level $j<X$ then this case applies. If the sum of the proportions of days exposed to any possible level is $>X$ then a warning indicator is set to 1. We note that even if the exposure is not binary and two exposure levels have equal frequencies, the tie indicator remains at 0 for case 2b (because $A(t)$ is then set to 0). -->

<!-- - $j < X$ and sum or proportions of days exposed $<X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-04-25"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-04-25","A=1","2021-05-06","2021-05-09"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-04-25","2021-05-06","2021-05-06","2021-05-09"), -->
<!--                                          end=c("2021-04-25",NA,NA,"2021-05-09",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - $j < X$ and sum or proportions of days exposed $\ge X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:5, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-03"), -->
<!-- #   group   = c(2,1,1,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-04","A=1","2021-05-06","2021-05-09"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-04","2021-05-06","2021-05-06","2021-05-09"), -->
<!--                                          end=c("2021-05-04",NA,NA,"2021-05-09",NA,NA), -->
<!--                                          type=c("background","box","box","background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4,2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.2.3 Case 3b -->

<!-- The exposure is binary, $t$ is the last interval and a right-censoring event occurs during the interval. We then compute the average exposure during the days of the interval **up to and including the day** when $C$ occurs. If this average is $\ge X$ then this case applies and we define $j=1$. Or, the exposure is not binary, $t$ is the last interval, the subject experiences a right-censoring event during interval $t$, and at least one of the exposure levels before the censoring event.  We then denote the most frequent exposure level in interval $t$ **up to and including the day when the censoring event occurs** by $j$. If the proportion of days exposed during interval $t$ to level $j\ge X$ then this case applies. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as $A(t-1)$, if $A(t-1)$ was set to one of the levels involved in the tie at time $t$; and, otherwise, (including if $t=0$) $k$ is set to the level involved in the tie that the patient experienced last duringthe interval $t$ and **up to and including the day when the censoring event occurs.** -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-14"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-08", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=1","2021-05-08","2021-05-17", -->
<!--                                                    "A=2","2021-04-22","2021-05-07", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-05-08","2021-05-08","2021-05-17", -->
<!--                                                  "2021-04-22","2021-04-22","2021-05-07", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-17",NA,NA, -->
<!--                                                "2021-05-07",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05", -->
<!--                                                    "A=1","2021-05-06","2021-05-20", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-20", -->
<!--                                                  "2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA, -->
<!--                                                "2021-05-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=2<br><b>Variable Assignment:</b><br>A(t)=k=2<br>Y(t)=0<br>C(t)=1<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-05", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-05", -->
<!--                                                    "A=1","2021-05-06","2021-05-20", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-05", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-20", -->
<!--                                                  "2021-05-20"), -->
<!--                                          end=c("2021-05-05",NA,NA, -->
<!--                                                "2021-05-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=3<br><b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=1<br>tie=1<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "431px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.2.4 Case 4b -->

<!-- The exposure is binary, $t$ is the last interval and a right-censoring event occurs during interval $t$. We then compute the average exposure during the days of the interval **up to and including the day** when $C$ occurs. If this average is $<X$, then this case applies. Or, the exposure is not binary, $t$ is the last interval, and the subject experiences a right-censoring event during interval $t$.  We then denote the most frequent exposure level in interval $t$ **up to and including the day when the censoring event occurs** by $j$. If the proportion of days exposed during interval $t$ to level $j<X$ then this case applies. If the sum of the proportions of days exposed to any possible level is $>X$ then a warning indicator is set to 1. We note that even if the exposure is not binary and two exposure levels have equal frequencies, the tie indicator remains at 0 for case 4b (because $A(t)$ is then set to 0).  -->

<!-- - $j < X$ and sum or proportions of days exposed $<X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-14"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-04-25", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-04-25", -->
<!--                                                    "A=1","2021-05-06","2021-05-09", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-04-25", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-09", -->
<!--                                                  "2021-05-09"), -->
<!--                                          end=c("2021-04-25",NA,NA, -->
<!--                                                "2021-05-09",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=0")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- - $j < X$ and sum or proportions of days exposed $\geq X$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:6, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "C=1"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-14"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-14", -->
<!-- #               "2021-05-03", -->
<!-- #               NA), -->
<!-- #   group   = c(2,1,1,3,3,3) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("A=2","2021-04-21","2021-05-04", -->
<!--                                                    "A=1","2021-05-06","2021-05-09", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-04", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-09", -->
<!--                                                  "2021-05-09"), -->
<!--                                          end=c("2021-05-04",NA,NA, -->
<!--                                                "2021-05-09",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box","background","box","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(2,3,4,2,3,4,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=1<br>tie=0<br>A0.warn=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "354px",width="1215px")  -->
<!-- ``` -->

<!-- ##### 5.1.2.5 Case 5b -->

<!-- The exposure is binary or categorical, $t$ is the last interval but not the first and the subject experiences the failure event during interval $t$. We then define $Z$ as the number of days in each interval (i.e., $Z=\text{unitdays}$) and we compute the average exposure during the $Z$ days **up to and including the day** when the failure event occurs. If this average is $\ge X$, then this case applies. Or, the exposure is binary or categorical, $t$ is the last and first interval (i.e., $t=0$), the subject experiences the failure event during interval $t$, and at least one of the exposure levels before the failure event. We denote the most frequent exposure **between and including the index date and the day when the failure event occurs** by "j". If the proportion of days exposed during interval $t$ to level $j \ge X$ then this case applies. If the exposure is not binary then two exposure levels might have equal frequencies. In that case, $j$ is set to level $k$ and an indicator of a tie in exposure frequency is created. Level $k$ is defined as $A(t-1)$, if $A(t-1)$ was set to one of the levels involved in the tie at time $t$;and, otherwise, (including if t=0) $k$ is set to the level involved in the tie that the patient experienced last during , **if $t=0$**, the interval $t$ **and up to and including the day when the failure event occurs** and, if **$t>0$**, the interval of $Z$ days **up to and including the day when the failure event occurs.** -->

<!-- ###### $t>0$ -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-20","2021-05-05", -->
<!--                                                    "A=1","2021-05-06","2021-05-20", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-20","2021-04-20","2021-05-05", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-20", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-05-05",NA,NA, -->
<!--                                                "2021-05-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=2<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "587px",width="1215px") -->
<!-- ``` -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-01", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-21", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-19","2021-05-03", -->
<!--                                                    "A=1","2021-05-04","2021-05-18", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-03", -->
<!--                                                  "2021-05-04","2021-05-04","2021-05-18", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-05-03",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=2<br><b>Variable Assignment:</b><br>A(t)=k=2<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "625px",width="1215px") -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-01", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-21", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-19","2021-05-03", -->
<!--                                                    "A=1","2021-05-04","2021-05-18", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-03", -->
<!--                                                  "2021-05-04","2021-05-04","2021-05-18", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-05-03",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>A(t-1)=3<br><b>Variable Assignment:</b><br>A(t)=k=1<br>Y(t)=0<br>C(t)=0<br>tie=1<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "625px",width="1215px") -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- - Highest frequency: -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:9, -->
<!-- #   content = c("intnum=0",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("Z days","2021-04-21","2021-05-18", -->
<!--                                                    "A=2","2021-04-29","2021-05-03", -->
<!--                                                    "A=1","2021-05-04","2021-05-18", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-18", -->
<!--                                                  "2021-04-29","2021-04-29","2021-05-03", -->
<!--                                                  "2021-05-04","2021-05-04","2021-05-18", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-05-03",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,2,3,4,2,3,4,3))) -->

<!-- case_data[1,"content"] <- "intnum=0" -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=1<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "547px",width="1215px") -->
<!-- ``` -->

<!-- - Tie -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:9, -->
<!-- #   content = c("intnum=0",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-05-03", -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("Z days","2021-04-21","2021-05-18", -->
<!--                                                    "A=2","2021-04-21","2021-05-04", -->
<!--                                                    "A=1","2021-05-05","2021-05-18", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-18", -->
<!--                                                  "2021-04-21","2021-04-21","2021-05-04", -->
<!--                                                  "2021-05-05","2021-05-05","2021-05-18", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-05-04",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,2,3,4,2,3,4,3))) -->

<!-- case_data[1,"content"] <- "intnum=0" -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=j=1<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "586px",width="1215px") -->
<!-- ``` -->

<!-- ##### 5.1.2.6 Case 6b   -->

<!-- The exposure is binary or categorical, $t$ is the last interval but not the first and the subject experiences the failure event during interval $t$. We denote the most frequent exposure level during the $Z$ days **up to and including the day** when the failure event occurs by $j$. If the proportion of days exposed during interval $t$ to level $j<X$ then this case applies. If the sum of the proportions of days exposed to any possible level is $>X$ then a warning indicator is set to 1. Or, the exposure is binary or categorical, $t$ is the last and first interval (i.e., $t=0$). We then compute the average exposure **between and including the index date and the day when the failure event occurs.** If this average is $<X$, then this case applies. We note that even if the exposure is not binary and two exposure levels have equal frequencies, the tie indicator remains at 0 for case 6b (because $A(t)$ is then set to 0).  -->

<!-- ###### $t>0$ -->

<!-- - Tie Scenario 1 ($A(t-1) \in k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:10, -->
<!-- #   content = c("intnum=t",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "intnum=t-1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-03-21", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-04-16", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-06", -->
<!-- #               "2021-05-01", -->
<!-- #               NA, -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,3,2,1,1) -->
<!-- # ) -->

<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-20","2021-04-28", -->
<!--                                                    "A=1","2021-05-06","2021-05-09", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-20","2021-04-20","2021-04-28", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-09", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-04-28",NA,NA, -->
<!--                                                "2021-05-09",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=0<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "550px",width="1215px") -->
<!-- ``` -->

<!-- - Tie Scenario 2 ($A(t-1) \notin k$): -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- # case_data <- data.frame( -->
<!-- #   id      = 1:9, -->
<!-- #   content = c("intnum=0",  -->
<!-- #               "intstart", -->
<!-- #               "intend", -->
<!-- #               "A=1", -->
<!-- #               "A=2", -->
<!-- #               "Y=1", -->
<!-- #               "Z days", -->
<!-- #               "Z.start", -->
<!-- #               "Z.end"), -->
<!-- #   start   = c("2021-04-20",  -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-20", -->
<!-- #               "2021-05-03", -->
<!-- #               "2021-04-21", -->
<!-- #               "2021-05-16", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-04-20", -->
<!-- #               "2021-05-16"), -->
<!-- #   end     = c("2021-05-20", -->
<!-- #               NA, -->
<!-- #               NA, -->
<!-- #               "2021-05-10", -->
<!-- #               "2021-04-28", -->
<!-- #               NA, -->
<!-- #               "2021-05-16", -->
<!-- #               NA, -->
<!-- #               NA), -->
<!-- #   group   = c(3,1,1,4,4,4,2,1,1) -->
<!-- # ) -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:16, -->
<!--                                          content=c("Z days","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "A=2","2021-04-20","2021-04-28", -->
<!--                                                    "A=1","2021-05-06","2021-05-12", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-04-20","2021-04-20","2021-04-28", -->
<!--                                                  "2021-05-06","2021-05-06","2021-05-12", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                "2021-04-28",NA,NA, -->
<!--                                                "2021-05-12",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,1,3,4,2,3,4,2,3,4,3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=1<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "550px",width="1215px") -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("Z days","2021-04-21","2021-05-18", -->
<!--                                                    "A=2","2021-04-29","2021-05-03", -->
<!--                                                    "A=1","2021-05-04","2021-05-13", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21","2021-04-21","2021-05-18", -->
<!--                                                  "2021-04-29","2021-04-29","2021-05-03", -->
<!--                                                  "2021-05-04","2021-05-04","2021-05-13", -->
<!--                                                  "2021-05-18"), -->
<!--                                          end=c("2021-05-18",NA,NA, -->
<!--                                                "2021-05-03",NA,NA, -->
<!--                                                "2021-05-13",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #8FCE00; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(1,3,4,2,3,4,2,3,4,3))) -->

<!-- case_data[1,"content"] <- "intnum=0" -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>A(t)=0<br>Y(t)=0<br>C(t)=0<br>tie=0<br>A0.warn=1<br><br>A(t+1)=missing<br>Y(t+1)=1<br>C(t+1)=missing")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "513px",width="1215px") -->
<!-- ``` -->


<!-- ### 5.2. Mapping of covariate information in input data sets to the output data set -->

<!-- Following the assignment of exposure, outcome and censoring values according to one of the two logics described above, the logic described below is implemented iteratively for $t=0, 1,...$ and for one subject at a time  to assign values to the  time-dependent covariates in the output data set. The notation $L(t)$ (also shorten with $L$) below refers to the covariate status at interval $t$ . For simplicity, we use the terminology “exposure level” in the tables below to designate a “non-reference exposure level”. -->

<!-- The logic below was designed to insure the fundamental time-ordering assumption between the covariates $L(t)$ and the exposure $A(t)$ or censoring variable $C(t)$ at each interval $t$, i.e., the covariate level at interval $t$ is defined from measurements that either (a) occurred before the exposure or censoring at interval $t$ or (b) are otherwise assumed not to be affected by the exposure and censoring level at time $t$ or thereafter. When the input data sets contain measurements of exposures or censoring events on the same day as covariate measurements, the user can specify separately for each covariate whether the latter assumption (b) holds using the `acute_change` argument of the `setCovariate()` function. In addition, the logic below insures that any given input covariate measurement for any given subject is mapped to at most one interval $t$ of that subject and that the measurements assigned to consecutive intervals are chronologically ordered according to their dates of collection specified in the input data sets. Furthermore, for each subject, only the covariate measurements in the cohort data set collected at the index date and the measurements in the corresponding input data sets that are collected strictly after the index dates are considered in the logic below.  Note that the covariate assignment rules identified by cases 6 and 8 below depend on the user-specified argument value for the `first_exp_rule` of the `construct()` function. -->


<!-- #### 5.2.1 Case 1 -->

<!-- Interval $t$ is the first interval and not the last interval, and the unit is deemed unexposed in this interval. Note that (even when `setCovariate(...,acute_change=TRUE)`) the covariate value from the cohort data set stamped with the index date (can be missing) is assigned to $L(0)$ in this case because it is assumed that the cohort data set characterizes each subject at the very beginning of the first interval $t=0$. -->

<!-- **Measurement exists on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:6, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=62.95")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "274px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement does not exist on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:5, -->
<!--                                          content=c("eGFR=60.62", -->
<!--                                                    "eGFR=59.71"), -->
<!--                                          start=c("2021-05-01", -->
<!--                                                  "2021-05-15"), -->
<!--                                          end=c(NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",2)), -->
<!--                                          group=c(3,3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "240px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.2 Case 2 -->

<!-- Interval $t$ is the first interval and not the last interval, and the unit is deemed exposed to one of the exposure levels. $L(0)$ is set to the last measurement strictly after index date up to and including (if `setCovariate(...,acute_change=FALSE)`), or not including, day when  exposure to level $j$ is first initiated. If no such measurement is available then the measurement on the index date is used instead (even if exposure to level $j$ starts on the index date and `acute_change=TRUE`).  -->

<!-- **Measurement exists on and after index date** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71", -->
<!--                                                    "A=2","2021-05-15","2021-05-20"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15","2021-05-15","2021-05-20"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-20",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=59.71")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "311px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71", -->
<!--                                                    "A=2","2021-05-15","2021-05-20"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15","2021-05-15","2021-05-20"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-20",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=60.62")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "311px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement do not exists after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "A=2","2021-05-15","2021-05-20"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-15","2021-05-15","2021-05-20"), -->
<!--                                          end=c(NA, -->
<!--                                                "2021-05-20",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=62.95")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "311px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement do not exists on or after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:6, -->
<!--                                          content=c("A=2","2021-05-15","2021-05-20"), -->
<!--                                          start=c("2021-05-15","2021-05-15","2021-05-20"), -->
<!--                                          end=c("2021-05-20",NA,NA), -->
<!--                                          type=c("background","box","box"), -->
<!--                                          style=c(rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "274px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.3 Case 3 -->

<!-- The unit is not deemed to change exposure status during interval $t$, and interval $t$ is not the last interval or the first interval. $L(t)$ is set to the last measurement in the previous interval strictly after the date when $L(t-1)$ is measured and is set to missing if no such measurement exists. -->

<!-- **Measurements exists after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",2)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=60.62")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "277px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after L(t-1)** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "277px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.4 Case 4 -->

<!-- The unit is deemed to change exposure status during interval $t$, and $t$ is not the last or the first interval. $L(t)$ is set to the last measurement in either the previous interval strictly after the date when $L(t-1)$ is measured (if assignment exists) or in the current interval up to and including (if `acute_change=FALSE`), or not including, the day when the new exposure status begins. $L(t)$ is set to missing if no such measurement exists. -->

<!-- **Measurements exists after $L(t-1)$ or the current interval** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "A=2","2021-04-28","2021-05-19"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-19"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-19",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=61.59")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "351px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "A=2","2021-04-28","2021-05-19"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-19"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-19",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.84")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "351px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after $L(t-1)$ or the current interval** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "A=2","2021-04-28","2021-05-19"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-19"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-19",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "314px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.5 Case 5 -->

<!-- Last interval $t$, the unit is not deemed to change exposure status, and a right-censoring event occurs. (This case also applies when interval $t$ is the first and the last interval). $L(t)$ is set to the last measurement in either the previous interval strictly after the date when $L(t-1)$ is measured (if assignment exists) or in the current interval up to and including (if `acute_change=FALSE`),  or not including, the day when $C$ occurs. If $t=0$ then $L(t)$ is set to the last measurement on or after the index date (even when `acute_change=TRUE`) and up to and including (if `acute_change=FALSE`),or not including, the day when $C$ occurs. $L(t)$ is set to missing if no such measurement exists. **Note that occurrence of a censoring event C on the index date should never happen or else the user should remove the unit from the cohort data set.** -->

<!-- ###### $t>0$ -->

<!-- **Measurements exists after $L(t-1)$ or the current interval** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:11, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=61.59")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "314px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:11, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.84")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "314px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after $L(t-1)$ or the current interval** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "277px",width="1215px")  -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- **Measurements exists on or after index date** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=59.71")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "274px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=60.62")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "274px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:5, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-15"), -->
<!--                                          end=c(NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",1), -->
<!--                                                  "background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=62.95")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "274px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist on or after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4, -->
<!--                                          content=c("C=1"), -->
<!--                                          start=c("2021-05-15"), -->
<!--                                          end=c(NA), -->
<!--                                          type=c("box"), -->
<!--                                          style=c("background-color: #E69138; font-size: 8pt"), -->
<!--                                          group=c(3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "237px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.6 Case 6 -->

<!-- Last interval $t$, the unit is not deemed to change exposure status, and the outcome event occurs. (This case also applies when interval $t$ is first and last interval). If `first_exp_rule=0` then case 6 above uses instead the algorithm described for case 13 below. $L(t)$ is set to the last measurement in either the previous interval strictly after the date when $L(t-1)$ is measured or on the index date if $t=0$ (even when `acute_change=TRUE`). $L(t)$ is set to missing if no such measurement exists. $L(t+1)$ is set to the last measurement strictly after the date when $L(t)$ is measured (or, if $L(t)$ is missing, strictly after the date of the last non-missing  measurement in prior intervals and either strictly after the last day of the previous interval if $t>0$ or strictly after the index date $if t=0$) and before or on the day the event occurred. $L(t+1)$ is set to missing if no such measurement exists. **Note that occurrence of the outcome  on the index date should never happen or else the user should remove the unit from the cohort data set.** -->

<!-- ###### $t>0$ -->

<!-- **Measurements exists in previous interval strictly after $L(t-1)$; and, measurements exists after $L(t)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:11, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=60.62<br>L(t+1)=61.59<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "374px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements exists in previous interval strictly after $L(t-1)$; and, measurements do no exist after $L(t)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:9, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",2), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=60.62<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "337px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist in previous interval strictly after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "337px",width="1215px")  -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- **Measurements exist on or after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:6, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-01"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",2), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(3,3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.95<br>L(t+1)=60.62<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "340px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement exists on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:5, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01"), -->
<!--                                          end=c(NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",1), -->
<!--                                                  "background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.95<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist on nor after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4, -->
<!--                                          content=c("Y=1"), -->
<!--                                          start=c("2021-05-01"), -->
<!--                                          end=c(NA), -->
<!--                                          type=c("box"), -->
<!--                                          style=c("background-color: #E06666; font-size: 8pt"), -->
<!--                                          group=c(3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "297px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.7 Case 7 -->

<!-- Last interval $t$, the unit is deemed to change exposure status, and a right-censoring event occurs. (This case also applies when the interval $t$ is first and last interval). $L(t)$ is set to the last measurement in either the previous interval strictly after the date when $L(t-1)$ is measured (if assignment exists) or  in the current interval up to and including (if `acute_change=FALSE`) , or not including, the day when $C$ occurs. If $t=0$ then $L(t)$ is set to the last measurement on or after the index date (even when `acute_change=TRUE`) and up to and including (if `acute_change=FALSE`),  or not including, the day when $C$ occurs. $L(t)$ is set to missing if no such measurement exists. -->

<!-- ###### $t>0$ -->

<!-- **Measurements exists after $L(t-1)$ or current interval** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:14, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "C=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=61.59")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "388px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:14, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "C=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.84")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "388px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after $L(t-1)$ or current interval** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:11, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "C=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "351px",width="1215px")  -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- **Measurements exists on or after index date** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-13"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=59.71")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "311px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=59.71", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-13"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=60.62")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "311px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements exist only on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-13"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",1), -->
<!--                                                  "background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=62.95")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "311px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist on nor after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-13"), -->
<!--                                          start=c("2021-05-15", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c("background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(0)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "274px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.8 Case 8 -->

<!-- The unit is deemed to change exposure status in the last interval $t$, and the outcome occurs. (This case also applies when interval $t$ is the first and last interval). If `first_exp_rule=0` then case 8 above uses instead the algorithm described for case 14 below. $L(t)$ is set to the last measurement in either the previous interval strictly after the date when $L(t-1)$ is measured (if assignment exists) or in the current interval up to and including (if `acute_change=FALSE`), or not including, the first day when the unit changes exposure status. If $t=0$ then $L(t)$ is set to the last measurement on or after the index date (even when `acute_change=TRUE`) and up to and including (if `acute_change=FALSE`), or not including, the first day when the unit changes exposure status. $L(t)$ is set to missing if no such measurement exists. $L(t+1)$ is set to the last measurement strictly after the date when $L(t)$ is measured (or, if $L(t)$ is missing, strictly after the date of the last non-missing  measurement in prior intervals and either  strictly after the first day when the unit changes exposure status if`acute_change=FALSE` or on or after the first day when the unit changes exposure status if `acute_change=TRUE`)  and before or on the day the event occurred. $L(t+1)$ is set to missing if no such measurement exists.  -->

<!-- ###### $t>0$ -->

<!-- **Measurements exists in previous interval strictly after $L(t-1)$; and, measurements exists after $L(t)$** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:14, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.84<br>L(t+1)=61.59<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "448px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:14, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=60.62<br>L(t+1)=61.59<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "448px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements exists in previous interval strictly after $L(t-1)$; and, measurements do no exist after $L(t)$** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.84<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "448px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:12, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",2), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=60.62<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "411px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist in previous interval strictly after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:11, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-23","2021-05-18"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-23","2021-04-23","2021-05-18"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-18",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                   rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "411px",width="1215px")  -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- **Measurements exist on or after index date** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("eGFR=62.14", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-05-01","2021-05-13"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-01","2021-05-01","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=63.84<br>L(t+1)=61.59<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("eGFR=62.14", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-05-01","2021-05-13"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-01", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-01","2021-05-01","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",3), -->
<!--                                                  "background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3,3,3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.14<br>L(t+1)=61.59<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements exist only on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("eGFR=62.14", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-05-01","2021-05-13"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-15", -->
<!--                                                  "2021-05-01","2021-05-01","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #C99DFA; font-size: 8pt",1), -->
<!--                                                  "background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.14<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist on nor after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("Y=1", -->
<!--                                                    "A=2","2021-05-01","2021-05-13"), -->
<!--                                          start=c("2021-05-15", -->
<!--                                                  "2021-05-01","2021-05-01","2021-05-13"), -->
<!--                                          end=c(NA, -->
<!--                                                "2021-05-13",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c("background-color: #E06666; font-size: 8pt", -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "297px",width="1215px")  -->
<!-- ``` -->


<!-- The rules above are implemented for each interval $t$ until after the first time $t$ (if any) when $A(t)$ is assigned a value other than 0/'not exposed'. For all subsequent intervals $t$ (if any), the following rules are applied iteratively instead. If the variable $X$ referenced below is not specified explicitly by the user in the function `construct()` (section 3 – see `exp_threshold`), it is then is set to 0.50 by default in the current implementation of the `LtAtStructuR` package. We note that case 9 is skipped intentionally below.  In all the examples below $X = 0.50$. -->


<!-- #### 5.2.9 Case 10 -->

<!-- The unit is not deemed to change exposure status during interval $t$, and interval $t$ is not the last interval. $L(t)$ is set to the last measurement in the previous interval strictly after the date when $L(t-1)$ is measured. $L(t)$ is set to missing if no such measurement exists. -->

<!-- **Measurements exists after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",2)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=60.62")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "277px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements does not exist after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "277px",width="1215px")  -->
<!-- ``` -->

<!-- #### 5.2.10 Case 11 -->

<!-- The unit is deemed to change exposure status during interval $t$, and interval $t$ is not the last interval: $d$ is the first day when the new exposure status is experienced in the interval. $L(t)$ is set to the last measurement in either the previous interval  strictly after the date when $L(t-1)$ is measured (if assignment exists) or in the current interval up to and including (if `acute_change=FALSE`), or not including day $d$. $L(t)$ is set to missing if no such measurement exists. Note that if $A(t-1)=j$ (exposed status) and $A(t)=0/\text{not exposed}$ then the start of non-exposure status is defined as the first day of the interval when the unit is unexposed to any exposure levels. If the patient is always exposed during the interval then the start of non-exposure is defined as the first day of the interval by default.  -->

<!-- **Measurements exist after $L(t-1)$** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "A=2","2021-04-28","2021-05-19"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-19"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-19",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=61.59")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "351px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:13, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=60.62", -->
<!--                                                    "eGFR=63.84", -->
<!--                                                    "eGFR=61.59", -->
<!--                                                    "A=2","2021-04-28","2021-05-19"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-23", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-19"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-19",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3,3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.84")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "351px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "A=2","2021-04-28","2021-05-19"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-19"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-19",NA,NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "314px",width="1215px")  -->
<!-- ``` -->


<!-- #### 5.2.11 Case 12 -->

<!-- Last interval $t$ with occurrence of a right-censoring event (exposure status may or may not change). $L(t)$ is set to the last measurement in either the previous interval strictly after the date when $L(t-1)$ is measured or in current interval up to and including (if `acute_change=FALSE`),  or not including day when $C$ occurs. $L(t)$ is set to missing if no such measurement exists. -->

<!-- **Measurements exist after $L(t-1)$ or current interval** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=64.37", -->
<!--                                                    "eGFR=61.34", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=61.34")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "314px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=64.37", -->
<!--                                                    "eGFR=61.34", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3,3,3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=64.37")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "314px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after $L(t-1)$ or current interval** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "C=1"), -->
<!--                                          start=c("2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-30", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("background","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E69138; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  3, -->
<!--                                                  3))) -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "277px",width="1215px")  -->
<!-- ``` -->

<!-- #### 5.2.12 Case 13 -->

<!-- Last interval $t$, the unit is not deemed to change exposure status, the outcome event occurs. $Z$ is the number of days in each interval. We call the Z-day interval before the event, $Z.last$, and the previous Z-day interval $Z.penultimate$. $L(t)$ is set to the last measurement in $Z.penultimate$ strictly after the date when $L(t-1)$ is measured. If $t=0$ then $L(t)$ is set instead to the measurement on the index date. $L(t)$ is set to missing if no such measurement exists. $L(t+1)$ is set to the last measurement strictly after the date when $L(t)$ is measured (or , strictly after the date of the last non-missing  measurement in prior intervals and strictly after the last day of $Z.penultimate$ if $L(t)$ is missing) and before or on the day the event occurred. $L(t+1)$ is set to missing if no such measurement exists.  -->

<!-- **Note: case 13 is applied at t=0 only when case 13 replaces cases 6.** -->

<!-- ###### $t>0$ -->

<!-- **Measurements exist after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:19, -->
<!--                                          content=c("Z.penultimate","2021-02-28","2021-03-29", -->
<!--                                                    "Z.last","2021-03-30","2021-04-28", -->
<!--                                                    "intnum=t-2","2021-02-20","2021-03-21", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=63.60", -->
<!--                                                    "eGFR=62.90", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-02-28","2021-02-28","2021-03-29", -->
<!--                                                  "2021-03-30","2021-03-30","2021-04-28", -->
<!--                                                  "2021-02-20","2021-02-20","2021-03-21", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-23", -->
<!--                                                  "2021-03-27", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-03-29",NA,NA, -->
<!--                                                "2021-04-28",NA,NA, -->
<!--                                                "2021-03-21",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #BF5858; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #C0C0C0; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  3,3,3, -->
<!--                                                  3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.60<br>L(t+1)=62.90<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "450px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist after $L(t-1)$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:17, -->
<!--                                          content=c("Z.penultimate","2021-02-28","2021-03-29", -->
<!--                                                    "Z.last","2021-03-30","2021-04-28", -->
<!--                                                    "intnum=t-2","2021-02-20","2021-03-21", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-02-28","2021-02-28","2021-03-29", -->
<!--                                                  "2021-03-30","2021-03-30","2021-04-28", -->
<!--                                                  "2021-02-20","2021-02-20","2021-03-21", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-23", -->
<!--                                                  "2021-04-28"), -->
<!--                                          end=c("2021-03-29",NA,NA, -->
<!--                                                "2021-04-28",NA,NA, -->
<!--                                                "2021-03-21",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #BF5858; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #C0C0C0; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  3, -->
<!--                                                  3))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "413px",width="1215px")  -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- **Measurement exists on or after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:6, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=61.05", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-10", -->
<!--                                                  "2021-05-17"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #A468E8; font-size: 8pt",2), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(3, -->
<!--                                                  3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.95<br>L(t+1)=61.05<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement exists on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:5, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "Y=1"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-17"), -->
<!--                                          end=c(NA, -->
<!--                                                NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box"), -->
<!--                                          style=c(rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(3, -->
<!--                                                  3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.95<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement does not exist on nor after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4, -->
<!--                                          content=c("Y=1"), -->
<!--                                          start=c("2021-05-17"), -->
<!--                                          end=c(NA), -->
<!--                                          type=c("box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",1)), -->
<!--                                          group=c(3))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "297px",width="1215px")  -->
<!-- ``` -->

<!-- #### 5.2.13 Case 14 -->

<!-- Last interval $t$, the unit is deemed to change exposure status, the outcome event occurs during $Z.last$: $d$ is the first day when the exposure status changes in the Z-day interval preceding Y. $L(t)$ is set to the last measurement in either $Z.penultimate$ strictly after the date when $L(t-1)$ is measured ) or in $Z.last$ up to and including (if no.acute. change=1 `acute_change=FALSE`),  or not including, day $d$ in $Z.last$. If $t=0$ then $L(t)$ is set to the last measurement on or after the index date (even when `acute_change=TRUE`) and up to and including (if `acute_change=FALSE`), or not including, the first day when the unit changes exposure status. $L(t)$ is set to missing if no such measurement exists. $L(t+1)$ is set to the last measurement strictly after the date when $L(t)$ is measured (or, if $L(t)$ is missing, , strictly after the date of the last non-missing measurement in prior intervals and either strictly after  day $d$ in $Z.last$ if also no.acute. change=1 `acute_change=FALSE` or on or after $d$ in $Z.last$ if also no.acute. change=0 `acute_change=TRUE`) and before or on the day the event occurred. $L(t+1)$ is set to missing if no such measurement exists. Note that the above implies that if $d$=index date and `acute_change=TRUE` then $L(t)$ is set to the measurement on the index date. Note that if $A(t-1)=j$ (exposed status) and $A(t)=0/\text{not exposed}$ then the start of non-exposure status is defined as the first day of the $Z.last$ interval when the unit is unexposed to any exposure levels. If the patient is always exposed during the $Z.last$ interval then the start of non-exposure is defined as the first day of the $Z.last$ interval by default. -->

<!-- **Note: case 14 is applied at t=0 only when case 14 replaces cases 8** -->

<!-- ###### $t>0$ -->

<!-- **Measurements exists in $Z.penultimate$ strictly after $L(t-1)$; and, measurements exists after $L(t)$** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:23, -->
<!--                                          content=c("Z.penultimate","2021-03-20","2021-04-18", -->
<!--                                                    "Z.last","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-2","2021-02-20","2021-03-21", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=63.50", -->
<!--                                                    "eGFR=62.60", -->
<!--                                                    "eGFR=62.90", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-16"), -->
<!--                                          start=c("2021-03-20","2021-03-20","2021-04-18", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-02-20","2021-02-20","2021-03-21", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-28", -->
<!--                                                  "2021-04-25", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-05-18", -->
<!--                                                  "2021-05-18", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-16"), -->
<!--                                          end=c("2021-04-18",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                "2021-03-21",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #BF5858; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #C0C0C0; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.50<br>L(t+1)=62.90<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "561px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:23, -->
<!--                                          content=c("Z.penultimate","2021-03-20","2021-04-18", -->
<!--                                                    "Z.last","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-2","2021-02-20","2021-03-21", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=63.50", -->
<!--                                                    "eGFR=62.60", -->
<!--                                                    "eGFR=62.90", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-16"), -->
<!--                                          start=c("2021-03-20","2021-03-20","2021-04-18", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-02-20","2021-02-20","2021-03-21", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-28", -->
<!--                                                  "2021-04-25", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-05-18", -->
<!--                                                  "2021-05-18", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-16"), -->
<!--                                          end=c("2021-04-18",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                "2021-03-21",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #BF5858; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #C0C0C0; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",4), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=62.60<br>L(t+1)=62.90<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "561px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements exists in $Z.penultimate$ strictly after $L(t-1)$; and, measurements do no exist after $L(t)$** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:22, -->
<!--                                          content=c("Z.penultimate","2021-03-20","2021-04-18", -->
<!--                                                    "Z.last","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-2","2021-02-20","2021-03-21", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "eGFR=63.50", -->
<!--                                                    "eGFR=62.60", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-16"), -->
<!--                                          start=c("2021-03-20","2021-03-20","2021-04-18", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-02-20","2021-02-20","2021-03-21", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-28", -->
<!--                                                  "2021-04-25", -->
<!--                                                  "2021-04-10", -->
<!--                                                  "2021-05-18", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-16"), -->
<!--                                          end=c("2021-04-18",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                "2021-03-21",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #BF5858; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #C0C0C0; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=63.50<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "561px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurements do not exist in $Z.penultimate$ strictly after $L(t-1)$, or in $Z.last$** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:20, -->
<!--                                          content=c("Z.penultimate","2021-03-20","2021-04-18", -->
<!--                                                    "Z.last","2021-04-19","2021-05-18", -->
<!--                                                    "intnum=t-2","2021-02-20","2021-03-21", -->
<!--                                                    "intnum=t-1","2021-03-22","2021-04-20", -->
<!--                                                    "eGFR=62.95", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-25","2021-05-16"), -->
<!--                                          start=c("2021-03-20","2021-03-20","2021-04-18", -->
<!--                                                  "2021-04-19","2021-04-19","2021-05-18", -->
<!--                                                  "2021-02-20","2021-02-20","2021-03-21", -->
<!--                                                  "2021-03-22","2021-03-22","2021-04-20", -->
<!--                                                  "2021-03-28", -->
<!--                                                  "2021-05-18", -->
<!--                                                  "2021-04-25","2021-04-25","2021-05-16"), -->
<!--                                          end=c("2021-04-18",NA,NA, -->
<!--                                                "2021-05-18",NA,NA, -->
<!--                                                "2021-03-21",NA,NA, -->
<!--                                                "2021-04-20",NA,NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "range","box","box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #BF5858; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #C0C0C0; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #7D7D7D; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  1,3,4, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"type"] <- "range" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Prior Variable Assignment:</b><br>L(t-1)=62.95<br><b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "524px",width="1215px")  -->
<!-- ``` -->

<!-- ###### $t=0$ -->

<!-- **Measurement exists on or after index date; and, measurements exists after $L(t)$** -->

<!-- `acute_change=FALSE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=61.05", -->
<!--                                                    "eGFR=62.65", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-28","2021-05-16"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-10", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-05-17", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-16"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.65<br>L(t+1)=61.05<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- `acute_change=TRUE` -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:10, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "eGFR=61.05", -->
<!--                                                    "eGFR=62.65", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-28","2021-05-16"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-10", -->
<!--                                                  "2021-04-28", -->
<!--                                                  "2021-05-17", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-16"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #A468E8; font-size: 8pt",3), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.95<br>L(t+1)=61.66<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement exists on index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:8, -->
<!--                                          content=c("eGFR=62.95", -->
<!--                                                    "Y=1", -->
<!--                                                    "A=2","2021-04-28","2021-05-16"), -->
<!--                                          start=c("2021-04-21", -->
<!--                                                  "2021-05-17", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-16"), -->
<!--                                          end=c(NA, -->
<!--                                                NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #A468E8; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=62.95<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "334px",width="1215px")  -->
<!-- ``` -->

<!-- **Measurement does not exist on nor after index date** -->

<!-- ```{r, fig.align="center", echo=FALSE, message=FALSE} -->
<!-- case_data <- rbind(case_data0,data.frame(id=4:7, -->
<!--                                          content=c("Y=1", -->
<!--                                                    "A=2","2021-04-28","2021-05-16"), -->
<!--                                          start=c("2021-05-17", -->
<!--                                                  "2021-04-28","2021-04-28","2021-05-16"), -->
<!--                                          end=c(NA, -->
<!--                                                "2021-05-16",NA,NA), -->
<!--                                          type=c("box", -->
<!--                                                 "background","box","box"), -->
<!--                                          style=c(rep("background-color: #E06666; font-size: 8pt",1), -->
<!--                                                  rep("background-color: #80B78A; font-size: 8pt",3)), -->
<!--                                          group=c(3, -->
<!--                                                  2,3,4))) -->
<!-- case_data[1,"content"] <- "intnum=0" -->

<!-- case_groups <- data.frame(id=1:5,content=c("Interval coursening", -->
<!--                                            "Exposures", -->
<!--                                            "Start date", -->
<!--                                            "End date", -->
<!--                                            "<b>Variable Assignment:</b><br>L(t)=NA<br>L(t+1)=NA<br>A(t+1)=NA<br>Y(t+1)=1")) -->
<!-- timevis::timevis(data=case_data, groups=case_groups, showZoom=FALSE, options = list( showCurrentTime = FALSE), height = "297px",width="1215px")  -->
<!-- ``` -->

<!-- Finally, for time-independent covariates the covariate $L(t)$ for interval $t=0$  is set, for each subject, to its measurement (if any)  at the index date contained in the cohort data set. Following the assignment of values to the covariates $L(t)$ according to the logic described above, any missing values at interval $t=0$ are imputed according to the methods specified by the `impute` argument of the `setCovarite()` function.  Any subsequent missing values (i.e., at $t>0$) are replaced by carrying forward the covariate value in the previous interval (possibly an imputed value). For each time-dependent covariate with potential missing values (i.e., covariates of type `sporadic`), an indicator of either imputation or of last value carried forward is created and included in the output data set.  -->

<!-- Finally, for each subject, the values $L(t)$ for $t=0,1,...$ of each time-independent covariate are set to the value specified at the index date in the input cohort data set. If this value is missing, the values $L(t)$ are set to an imputed value according to the method specified by the list element value of `impute` to the argument `L0_timeIndep` of the `setCohort()` function.   An indicator of imputation is created for each covariate and included in the output data set. -->



